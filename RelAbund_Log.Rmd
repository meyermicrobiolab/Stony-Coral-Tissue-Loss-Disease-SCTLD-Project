---
title: "Does log scale help plots of relative abundance?"
author: "J. Meyer"
date: "8/12/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(phyloseq)
library(dplyr)
library(reshape2)
library(tibble)
library(cowplot)
```

## Figure 5 RELATIVE ABUNDANCE OF DIFFERENTIALLY ABUNDANT ASVs 
First, load ASV table, taxonomy, and metadata and then pull out the relative abundance of the 5 ASVs that were differentially abundant in diseased versus apparently healthy tissue in each of 3 coral species, as determined by DESeq2.

```{r echo=FALSE}
otu <- read.table("Fieldsites_ps5_silva_nochloronomito_otu_table.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("Fieldsites_ps5_silva_nochloronomito_taxa_table.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("Fieldsites_ps5_silva_metadata.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps5 <- phyloseq(otu_table(otu, taxa_are_rows=FALSE), 
               sample_data(samples), 
               tax_table(taxon))
ps_ra<-transform_sample_counts(ps5, function(OTU) OTU/sum(OTU))
ps5.subset <- subset_taxa(ps_ra, rownames(tax_table(ps_ra)) %in% c("TACGGAGGGTCCAAGCGTTATCCGGATTTATTGGGTTTAAAGGGTCCGTAGGCGGGGTTTTAAGTCAGTGGTGAAAGCCTACAGCTCAACTGTAGAACTGCCATTGAAACTGGAACTCTTGAATGTGATTGAGGTAGGCGGAATATGTCATGTAGCGGTGAAATGCTTAGATATGACATAGAACACCGATAGCGAAGGCAGCTTACCAAGTCATTATTGACGCTGATGGACGAAAGCGTGGGGAGCGAACAGG", "TACGTAGGGGGCAAGCGTTATCCGGAATCACTGGGCGTAAAGGGTGCGTAGGCGGTTTTTCAAGTCAGAAGTGAAAGGCTATGGCTCAACCATAGTAAGCTTTTGAAACTGTTAAACTTGAGTGCAGGAGAGGAAAGTGGAATTCCTAGTGTAGAGGTGAAATTCGTAGATATTAGGAGGAACACCAGTGGCGAAGGCGACTTTCTGGACTGTAACTGACGCTGAGGCACGAAAGCGTGGGGAGCGAACAGG","TACGGAGGGGGTTAGCGTTGTTCGGAATTACTGGGCGTAAAGCGCACGTAGGCGGATTAGTCAGTCAGAGGTGAAATCCCAGGGCTCAACCCTGGAACTGCCTTTGATACTGCTAGTCTTGAGTTCGAGAGAGGTGAGTGGAATTCCGAGTGTAGAGGTGAAATTCGTAGATATTCGGAGGAACACCAGTGGCGAAGGCGGCTCACTGGCTCGATACTGACGCTGAGGTGCGAAAGTGTGGGGAGCAAACAGG","TACGGAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGTACGCAGGCGGTTAGTTAAGTCAGATGTGAAAGCCCCGGGCTCAACCTGGGAACTGCATTTGAAACTGGCTAACTAGAGTGCGACAGAGGGTGGTAGAATTTCAGGTGTAGCGGTGAAATGCGTAGAGATCTGAAGGAATACCGATGGCGAAGGCAGCCACCTGGGTCGACACTGACGCTCATGTACGAAAGCGTGGGTAGCAAACAGG","TACGGAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGCATGCAGGTGGTTTGTTAAGTCAGATGTGAAAGCCCTGGGCTCAACCCGGGAAGGTCATTTGAAACTGGCAAGCTAGAGTACTGTAGAGGGGGGTAGAATTTCAGGTGTAGCGGTGAAATGCGTAGAGATCTGAAGGAATACCGGTGGCGAAGGCGGCCCCCTGGACAGATACTGACACTCAGATGCGAAAGCGTGGGGAGCAAACAGG"))
otu = as(otu_table(ps5.subset), "matrix")
taxon = as(tax_table(ps5.subset), "matrix")
metadata = as(sample_data(ps5.subset), "matrix")
colnames(otu)[colnames(otu)=="TACGGAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGCATGCAGGTGGTTTGTTAAGTCAGATGTGAAAGCCCTGGGCTCAACCCGGGAAGGTCATTTGAAACTGGCAAGCTAGAGTACTGTAGAGGGGGGTAGAATTTCAGGTGTAGCGGTGAAATGCGTAGAGATCTGAAGGAATACCGGTGGCGAAGGCGGCCCCCTGGACAGATACTGACACTCAGATGCGAAAGCGTGGGGAGCAAACAGG"] <- "Cryomorphaceae"
colnames(otu)[colnames(otu)=="TACGTAGGGGGCAAGCGTTATCCGGAATCACTGGGCGTAAAGGGTGCGTAGGCGGTTTTTCAAGTCAGAAGTGAAAGGCTATGGCTCAACCATAGTAAGCTTTTGAAACTGTTAAACTTGAGTGCAGGAGAGGAAAGTGGAATTCCTAGTGTAGAGGTGAAATTCGTAGATATTAGGAGGAACACCAGTGGCGAAGGCGACTTTCTGGACTGTAACTGACGCTGAGGCACGAAAGCGTGGGGAGCGAACAGG"] <- "Fusibacter"
colnames(otu)[colnames(otu)=="TACGGAGGGTCCAAGCGTTATCCGGATTTATTGGGTTTAAAGGGTCCGTAGGCGGGGTTTTAAGTCAGTGGTGAAAGCCTACAGCTCAACTGTAGAACTGCCATTGAAACTGGAACTCTTGAATGTGATTGAGGTAGGCGGAATATGTCATGTAGCGGTGAAATGCTTAGATATGACATAGAACACCGATAGCGAAGGCAGCTTACCAAGTCATTATTGACGCTGATGGACGAAAGCGTGGGGAGCGAACAGG"] <- "Planktotalea"
colnames(otu)[colnames(otu)=="TACGGAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGTACGCAGGCGGTTAGTTAAGTCAGATGTGAAAGCCCCGGGCTCAACCTGGGAACTGCATTTGAAACTGGCTAACTAGAGTGCGACAGAGGGTGGTAGAATTTCAGGTGTAGCGGTGAAATGCGTAGAGATCTGAAGGAATACCGATGGCGAAGGCAGCCACCTGGGTCGACACTGACGCTCATGTACGAAAGCGTGGGTAGCAAACAGG"] <- "Algicola"
colnames(otu)[colnames(otu)=="TACGGAGGGGGTTAGCGTTGTTCGGAATTACTGGGCGTAAAGCGCACGTAGGCGGATTAGTCAGTCAGAGGTGAAATCCCAGGGCTCAACCCTGGAACTGCCTTTGATACTGCTAGTCTTGAGTTCGAGAGAGGTGAGTGGAATTCCGAGTGTAGAGGTGAAATTCGTAGATATTCGGAGGAACACCAGTGGCGAAGGCGGCTCACTGGCTCGATACTGACGCTGAGGTGCGAAAGTGTGGGGAGCAAACAGG"] <- "Vibrio"
otu<-as.data.frame(otu)
otu<-rownames_to_column(otu,var="Sample")
metadata<-as.data.frame(metadata)
metadata<-rownames_to_column(metadata,var="Sample")
otu.meta<-merge(metadata,otu,"Sample")
write.table(otu.meta,"5ASVS.txt",sep="\t",col.names=NA)
otu_long<-melt(otu.meta,id.vars=c("Sample","Coral","Colony","Condition","Near_Far","Source","Site"),variable.name="ASV",value.name="Proportion")
otu_long$Coral<-factor(otu_long$Coral,levels=c("Montastraea cavernosa","Orbicella faveolata","Diploria labyrinthiformis","Dichocoenia stokesii"))
asv1<-otu_long[grepl("Cryomorphaceae", otu_long$ASV),]
asv2<-otu_long[grepl("Fusibacter", otu_long$ASV),]
asv3<-otu_long[grepl("Planktotalea", otu_long$ASV),]
asv4<-otu_long[grepl("Algicola", otu_long$ASV),]
asv5<-otu_long[grepl("Vibrio", otu_long$ASV),]
```

## Plot relative abundance, without any transformation


```{r echo=FALSE}
cols<-c("lesion"="#D55E00", "non-lesion"="#999999")
p1<-ggplot(asv1, aes(x=Source,y=Proportion))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("Relative Abundance")+
  ggtitle("Cryomorphaceae")

p2<-ggplot(asv2, aes(x=Source,y=Proportion))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("Relative Abundance")+
  ggtitle("Fusibacter")+
  theme(plot.title = element_text(face="italic"))

p3<-ggplot(asv3, aes(x=Source,y=Proportion))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("Relative Abundance")+
  ggtitle("Planktotalea")+
  theme(plot.title = element_text(face="italic"))

p4<-ggplot(asv4, aes(x=Source,y=Proportion))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("Relative Abundance")+
  ggtitle("Algicola")+
  theme(plot.title = element_text(face="italic"))
  
p5<-ggplot(asv5, aes(x=Source,y=Proportion))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("Relative Abundance")+
  ggtitle("Vibrio")+
  theme(plot.title = element_text(face="italic"))

#pdf("Figure5_RelAbund_5ASVs.pdf",width=8.5,height=11)
plot_grid(p1,p2,p3,p4,p5, labels=c("A","B","C","D","E"), ncol=1, nrow=5)
#dev.off()

```

## Plot relative abundance using a log scale

First, add 0.0001 to all of the relative abundance values to avoid taking the log of zero.

```{r echo=FALSE}
p1<-ggplot(asv1, aes(x=Source,y=log(Proportion+0.0001)))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("log(Relative Abundance+0.0001)")+
  ggtitle("Cryomorphaceae")

p2<-ggplot(asv2, aes(x=Source,y=log(Proportion+0.0001)))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("log(Relative Abundance+0.0001)")+
  ggtitle("Fusibacter")+
  theme(plot.title = element_text(face="italic"))

p3<-ggplot(asv3, aes(x=Source,y=log(Proportion+0.0001)))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("log(Relative Abundance+0.0001)")+
  ggtitle("Planktotalea")+
  theme(plot.title = element_text(face="italic"))

p4<-ggplot(asv4, aes(x=Source,y=log(Proportion+0.0001)))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("log(Relative Abundance+0.0001)")+
  ggtitle("Algicola")+
  theme(plot.title = element_text(face="italic"))
  
p5<-ggplot(asv5, aes(x=Source,y=log(Proportion+0.0001)))+
  geom_boxplot()+
  geom_jitter(position=position_jitter(width=.1, height=0),aes(fill=Source),size=2,shape=21)+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  theme(text=element_text(size=14))+
  facet_grid(.~Coral)+
  theme(strip.text.x=element_text(face="italic",size=10))+
  scale_fill_manual(values=cols)+
  ylab("log(Relative Abundance+0.0001)")+
  ggtitle("Vibrio")+
  theme(plot.title = element_text(face="italic"))

#pdf("Figure5_RelAbund_5ASVs_log.pdf",width=8.5,height=11)
plot_grid(p1,p2,p3,p4,p5, labels=c("A","B","C","D","E"), ncol=1, nrow=5)
#dev.off()
```

